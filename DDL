-- Tablas --
CREATE TABLE IF NOT EXISTS marcas (
  marca_id INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(100) NOT NULL UNIQUE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE IF NOT EXISTS concesionarias (
  concesionaria_id INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(150) NOT NULL,
  domicilio VARCHAR(255) NOT NULL,
  telefono VARCHAR(50) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE IF NOT EXISTS servicios_oficiales (
  servicio_id INT PRIMARY KEY AUTO_INCREMENT,
  concesionaria_id INT NOT NULL,
  nombre VARCHAR(150) NOT NULL,
  domicilio VARCHAR(255) NOT NULL,
  telefono VARCHAR(50) NOT NULL,
  CONSTRAINT fk_servicio_concesionaria
    FOREIGN KEY (concesionaria_id) REFERENCES concesionarias(concesionaria_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE IF NOT EXISTS vendedores (
  vendedor_id INT PRIMARY KEY AUTO_INCREMENT,
  concesionaria_id INT NOT NULL,
  nombre VARCHAR(120) NOT NULL,
  domicilio VARCHAR(255) NOT NULL,
  telefono VARCHAR(50) NOT NULL,
  whatsapp VARCHAR(50) NOT NULL,
  email VARCHAR(150) NOT NULL,
  CONSTRAINT fk_vendedor_concesionaria
    FOREIGN KEY (concesionaria_id) REFERENCES concesionarias(concesionaria_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE IF NOT EXISTS modelos (
  modelo_id INT PRIMARY KEY AUTO_INCREMENT,
  marca_id INT NOT NULL,
  nombre_modelo VARCHAR(120) NOT NULL,
  anio INT NOT NULL,
  tipo_motor ENUM('Gasolina','Diésel','Híbrido','Eléctrico') NOT NULL,
  potencia_hp INT NOT NULL,
  cilindros INT NOT NULL,
  precio_base DECIMAL(12,2) NOT NULL,
  CONSTRAINT fk_modelo_marca FOREIGN KEY (marca_id) REFERENCES marcas(marca_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE IF NOT EXISTS caracteristicas (
  caracteristica_id INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(150) NOT NULL UNIQUE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE IF NOT EXISTS modelo_caracteristica (
  modelo_id INT NOT NULL,
  caracteristica_id INT NOT NULL,
  inclusion ENUM('SERIE','EXTRA') NOT NULL,
  precio_extra DECIMAL(12,2) NULL,
  PRIMARY KEY (modelo_id, caracteristica_id),
  CONSTRAINT fk_mc_modelo FOREIGN KEY (modelo_id) REFERENCES modelos(modelo_id),
  CONSTRAINT fk_mc_feature FOREIGN KEY (caracteristica_id) REFERENCES caracteristicas(caracteristica_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE IF NOT EXISTS inventario (
  vin VARCHAR(20) PRIMARY KEY,
  modelo_id INT NOT NULL,
  concesionaria_id INT NULL,
  servicio_id INT NULL,
  ubicacion_tipo ENUM('CONCESIONARIA','SUCURSAL','ALMACEN','SERVICIO_OFICIAL') NOT NULL,
  ubicacion_detalle VARCHAR(200) NOT NULL,
  precio_publico DECIMAL(12,2) NOT NULL,
  descuento DECIMAL(12,2) DEFAULT 0 NOT NULL,
  en_stock BOOLEAN NOT NULL DEFAULT TRUE,
  CONSTRAINT fk_inv_modelo FOREIGN KEY (modelo_id) REFERENCES modelos(modelo_id),
  CONSTRAINT fk_inv_concesionaria FOREIGN KEY (concesionaria_id) REFERENCES concesionarias(concesionaria_id),
  CONSTRAINT fk_inv_servicio FOREIGN KEY (servicio_id) REFERENCES servicios_oficiales(servicio_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE IF NOT EXISTS ventas (
  venta_id INT PRIMARY KEY AUTO_INCREMENT,
  fecha DATE NOT NULL,
  concesionaria_id INT NOT NULL,
  modelo_id INT NOT NULL,
  vin VARCHAR(20) NULL,
  precio_venta DECIMAL(12,2) NOT NULL,
  modo_pago ENUM('CONTADO','CREDITO') NOT NULL,
  vendedor_id INT NULL,
  servicio_id INT NULL,
  era_stock BOOLEAN NOT NULL,
  fecha_entrega DATE NOT NULL,
  matricula VARCHAR(12) NOT NULL,
  CONSTRAINT fk_venta_concesionaria FOREIGN KEY (concesionaria_id) REFERENCES concesionarias(concesionaria_id),
  CONSTRAINT fk_venta_modelo FOREIGN KEY (modelo_id) REFERENCES modelos(modelo_id),
  CONSTRAINT fk_venta_vendedor FOREIGN KEY (vendedor_id) REFERENCES vendedores(vendedor_id),
  CONSTRAINT fk_venta_servicio FOREIGN KEY (servicio_id) REFERENCES servicios_oficiales(servicio_id),
  CONSTRAINT chk_quien_vendio CHECK ((vendedor_id IS NULL) XOR (servicio_id IS NULL))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE IF NOT EXISTS venta_extras (
  venta_id INT NOT NULL,
  caracteristica_id INT NOT NULL,
  precio DECIMAL(12,2) NOT NULL,
  PRIMARY KEY (venta_id, caracteristica_id),
  CONSTRAINT fk_ve_venta FOREIGN KEY (venta_id) REFERENCES ventas(venta_id),
  CONSTRAINT fk_ve_car FOREIGN KEY (caracteristica_id) REFERENCES caracteristicas(caracteristica_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE IF NOT EXISTS ventas_acumuladas (
  venta_id INT PRIMARY KEY,
  fecha DATE NOT NULL,
  concesionaria_id INT NOT NULL,
  modelo_id INT NOT NULL,
  vendedor_id INT NULL,
  servicio_id INT NULL,
  precio_venta DECIMAL(12,2) NOT NULL,
  modo_pago ENUM('CONTADO','CREDITO') NOT NULL,
  CONSTRAINT fk_va_concesionaria FOREIGN KEY (concesionaria_id) REFERENCES concesionarias(concesionaria_id),
  CONSTRAINT fk_va_modelo FOREIGN KEY (modelo_id) REFERENCES modelos(modelo_id),
  CONSTRAINT fk_va_vendedor FOREIGN KEY (vendedor_id) REFERENCES vendedores(vendedor_id),
  CONSTRAINT fk_va_servicio FOREIGN KEY (servicio_id) REFERENCES servicios_oficiales(servicio_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
