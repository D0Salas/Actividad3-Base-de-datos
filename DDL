-- DDL --
CREATE TABLE concesionarias (
  concesionaria_id INT AUTO_INCREMENT PRIMARY KEY,
  sede        VARCHAR(100) NOT NULL,   
  domicilio   VARCHAR(200) NOT NULL,
  telefono    VARCHAR(30)  NOT NULL
);

CREATE TABLE servicios_oficiales (
  servicio_id       INT AUTO_INCREMENT PRIMARY KEY,
  concesionaria_id  INT NOT NULL,
  nombre            VARCHAR(120) NOT NULL,
  domicilio         VARCHAR(200) NOT NULL,
  telefono          VARCHAR(30)  NOT NULL,
  CONSTRAINT fk_so_concesionaria
    FOREIGN KEY (concesionaria_id) REFERENCES concesionarias(concesionaria_id)
);

CREATE TABLE caracteristicas (
  caracteristica_id INT AUTO_INCREMENT PRIMARY KEY,
  nombre       VARCHAR(80)  NOT NULL UNIQUE,
  descripcion  VARCHAR(200)
);

CREATE TABLE empleados (
  empleado_id       INT AUTO_INCREMENT PRIMARY KEY,
  concesionaria_id  INT NOT NULL,  
  nombre            VARCHAR(120) NOT NULL,
  domicilio         VARCHAR(200) NOT NULL,
  telefono          VARCHAR(30) NOT NULL,
  whatsapp          VARCHAR(30) NOT NULL,
  email             VARCHAR(120) NOT NULL,
  ventas_total      INT NOT NULL DEFAULT 0, 
  CONSTRAINT fk_emp_concesionaria
    FOREIGN KEY (concesionaria_id) REFERENCES concesionarias(concesionaria_id)
);

CREATE TABLE aditamentos (
  aditamento_id INT AUTO_INCREMENT PRIMARY KEY,
  nombre        VARCHAR(120) NOT NULL UNIQUE,
  descripcion   VARCHAR(200) NOT NULL
);

CREATE TABLE inventario (
  inventario_id     INT AUTO_INCREMENT PRIMARY KEY,
  automovil         VARCHAR(120) NOT NULL,     -- nombre/comercial
  marca             VARCHAR(80)  NOT NULL,
  modelo            VARCHAR(120) NOT NULL,
  anio              SMALLINT     NOT NULL,
  vin               VARCHAR(30)  UNIQUE,       -- número de serie
  caracteristica_id INT          NOT NULL,     -- FK a Caracteristicas
  concesionaria_id  INT          NULL,         -- si está en sede/almacén
  servicio_id       INT          NULL,         -- si está en servicio oficial
  precio            DECIMAL(12,2) NOT NULL,
  en_stock          BOOLEAN       NOT NULL DEFAULT TRUE,
  -- Debe estar en UNA ubicación: concesionaria XOR servicio oficial
  CONSTRAINT chk_inv_ubicacion
    CHECK (
      (servicio_id IS NULL AND concesionaria_id IS NOT NULL)
      OR (servicio_id IS NOT NULL AND concesionaria_id IS NULL)
    ),
  CONSTRAINT fk_inv_caracteristica
    FOREIGN KEY (caracteristica_id) REFERENCES caracteristicas(caracteristica_id),
  CONSTRAINT fk_inv_concesionaria
    FOREIGN KEY (concesionaria_id) REFERENCES concesionarias(concesionaria_id),
  CONSTRAINT fk_inv_servicio
    FOREIGN KEY (servicio_id) REFERENCES servicios_oficiales(servicio_id)
);

CREATE TABLE ventas (
  venta_id         INT AUTO_INCREMENT PRIMARY KEY,
  vin              VARCHAR(30) NULL,  
  vendedor_id      INT NULL,          
  servicio_id      INT NULL,          
  concesionaria_id INT NOT NULL,      
  precio_venta     DECIMAL(12,2) NOT NULL,
  metodo_pago      ENUM('CONTADO','CREDITO') NOT NULL,
  fecha            DATE NOT NULL DEFAULT (CURRENT_DATE),
  fecha_entrega    DATE,
  matricula        VARCHAR(20),
  era_stock        BOOLEAN NOT NULL DEFAULT TRUE, -- TRUE=de stock, FALSE=fábrica
  CONSTRAINT chk_venta_canal
    CHECK ( (vendedor_id IS NULL) <> (servicio_id IS NULL) ),
  CONSTRAINT fk_venta_vin
    FOREIGN KEY (vin) REFERENCES inventario(vin),
  CONSTRAINT fk_venta_vendedor
    FOREIGN KEY (vendedor_id) REFERENCES empleados(empleado_id),
  CONSTRAINT fk_venta_servicio
    FOREIGN KEY (servicio_id) REFERENCES servicios_oficiales(servicio_id),
  CONSTRAINT fk_venta_concesionaria
    FOREIGN KEY (concesionaria_id) REFERENCES concesionarias(concesionaria_id)
);

CREATE TABLE venta_aditamentos (
  venta_id       INT NOT NULL,
  aditamento_id  INT NOT NULL,
  precio_extra   DECIMAL(12,2) NOT NULL,
  PRIMARY KEY (venta_id, aditamento_id),
  CONSTRAINT fk_va_venta
    FOREIGN KEY (venta_id)      REFERENCES ventas(venta_id) ON DELETE CASCADE,
  CONSTRAINT fk_va_aditamento
    FOREIGN KEY (aditamento_id) REFERENCES aditamentos(aditamento_id)
);

CREATE TABLE ventas_acumuladas (
  acumulada_id     INT AUTO_INCREMENT PRIMARY KEY,
  concesionaria_id INT NOT NULL,
  vendedor_id      INT NULL,
  servicio_id      INT NULL,
  fecha            DATE NOT NULL,
  metodo_pago      ENUM('CONTADO','CREDITO') NOT NULL,
  vin              VARCHAR(30) NULL,
  automovil        VARCHAR(120) NOT NULL,
  marca            VARCHAR(80)  NOT NULL,
  modelo           VARCHAR(120) NOT NULL,
  anio             SMALLINT     NOT NULL,
  era_stock        BOOLEAN NOT NULL,
  precio_auto      DECIMAL(12,2) NOT NULL,
  extras           DECIMAL(12,2) NOT NULL DEFAULT 0,
  total_venta      DECIMAL(12,2) NOT NULL,
  fecha_entrega    DATE NULL,
  matricula        VARCHAR(20) NULL,
  CONSTRAINT chk_va_canal CHECK ((vendedor_id IS NULL) <> (servicio_id IS NULL)),
  CONSTRAINT fk_va_concesionaria FOREIGN KEY (concesionaria_id) REFERENCES concesionarias(concesionaria_id),
  CONSTRAINT fk_va_vendedor      FOREIGN KEY (vendedor_id)      REFERENCES empleados(empleado_id),
  CONSTRAINT fk_va_servicio      FOREIGN KEY (servicio_id)      REFERENCES servicios_oficiales(servicio_id),
  CONSTRAINT fk_va_vin           FOREIGN KEY (vin)              REFERENCES inventario(vin),
  KEY idx_va_conc_fecha (concesionaria_id, fecha),
  KEY idx_va_vendedor (vendedor_id),
  KEY idx_va_servicio (servicio_id),
  KEY idx_va_vin (vin)
);

